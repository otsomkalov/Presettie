trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  Runtime: 'linux-x64'
  BuildConfiguration: 'Release'

stages:
  - stage: build
    displayName: 'Build'
    jobs:
      - job: build_all
        steps:
          - task: UseDotNet@2
            inputs:
              version: '9.x'
          - task: DotNetCoreCLI@2
            name: Restore
            inputs:
              command: 'restore'
              projects: 'src/**/**.fsproj'
              arguments: '-r $(Runtime) -с $(BuildConfiguration)'
          - task: DotNetCoreCLI@2
            name: Build_Bot
            inputs:
              command: 'build'
              projects: 'src/**/Generator.fsproj'
              arguments: '-r $(Runtime) -с $(BuildConfiguration)'
              publishWebProjects: false
          - task: DotNetCoreCLI@2
            name: Build_API
            inputs:
              command: 'build'
              projects: 'src/**/API.fsproj'
              arguments: '-r $(Runtime) -с $(BuildConfiguration)'
              publishWebProjects: false
          - task: DotNetCoreCLI@2
            name: Build_Web
            inputs:
              command: 'build'
              projects: 'src/**/Web.fsproj'
              arguments: '-с $(BuildConfiguration)'
              publishWebProjects: false
          - task: DotNetCoreCLI@2
            name: Test
            inputs:
              command: 'test'
              projects: 'tests/**/**.fsproj'
              arguments: '-r $(Runtime) -с $(BuildConfiguration) --collect:"XPlat Code Coverage"'
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish coverage'
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/*/coverage.cobertura.xml'
          - task: DotNetCoreCLI@2
            name: Publish_Bot
            inputs:
              command: 'publish'
              projects: 'src/**/Generator.fsproj'
              arguments: '-r $(Runtime) -o $(Build.ArtifactStagingDirectory)/Generator /p:InformationalVersion=$(Build.BuildNumber)'
              publishWebProjects: false
          - task: DotNetCoreCLI@2
            name: Publish_API
            inputs:
              command: 'publish'
              projects: 'src/**/API.fsproj'
              arguments: '-r $(Runtime) -o $(Build.ArtifactStagingDirectory)/API /p:InformationalVersion=$(Build.BuildNumber)'
              publishWebProjects: false
          - task: DotNetCoreCLI@2
            name: Publish_Web
            inputs:
              command: 'publish'
              projects: 'src/**/Web.fsproj'
              arguments: '-r $(Runtime) -o $(Build.ArtifactStagingDirectory) /p:InformationalVersion=$(Build.BuildNumber)'
              publishWebProjects: false
              zipAfterPublish: false
          - task: PublishBuildArtifacts@1
            name: Pack_Bot
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/Generator'
              ArtifactName: 'Bot'
          - task: PublishBuildArtifacts@1
            name: Pack_API
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/API'
              ArtifactName: 'API'
          - task: PublishBuildArtifacts@1
            name: Pack_Web
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/Web/wwwroot'
              ArtifactName: 'Web'
  - stage: deploy_dev
    displayName: 'Deploy DEV'
    trigger: manual
    variables:
      - group: dev
    jobs:
      - deployment: deploy_bot
        displayName: Deploy Bot
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: Bot

                - task: AzureFunctionApp@2
                  inputs:
                    azureSubscription: '$(subscription)'
                    appType: 'functionAppLinux'
                    appName: '$(bot-functions-name)'
                    package: '$(Pipeline.Workspace)/**/*.zip'
      - deployment: deploy_api
        displayName: Deploy API
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: API

                - task: AzureFunctionApp@2
                  inputs:
                    azureSubscription: '$(subscription)'
                    appType: 'functionAppLinux'
                    appName: '$(api-functions-name)'
                    package: '$(Pipeline.Workspace)/**/*.zip'
      - job: deploy_web
        displayName: 'Deploy Web'
        steps:
          - checkout: none
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'Web'
              targetPath: '$(Build.ArtifactStagingDirectory)/Web'
          - task: AzureFileCopy@6
            displayName: 'Copy Web to Blob Storage'
            inputs:
              SourcePath: '$(Build.ArtifactStagingDirectory)/Web/**'
              azureSubscription: '$(subscription)'
              Destination: 'AzureBlob'
              storage: '$(web-storage-account)'
              ContainerName: '$web'
  - stage: deploy_prd
    displayName: 'Deploy PRD'
    variables:
      - group: prd
    jobs:
      - deployment: deploy_bot
        displayName: Deploy Bot
        environment: 'prd'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: Bot

                - task: AzureFunctionApp@2
                  inputs:
                    azureSubscription: '$(subscription)'
                    appType: 'functionAppLinux'
                    appName: '$(bot-functions-name)'
                    package: '$(Pipeline.Workspace)/**/*.zip'
      - deployment: deploy_api
        displayName: Deploy API
        environment: 'prd'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: API

                - task: AzureFunctionApp@2
                  inputs:
                    azureSubscription: '$(subscription)'
                    appType: 'functionAppLinux'
                    appName: '$(api-functions-name)'
                    package: '$(Pipeline.Workspace)/**/*.zip'
      - job: deploy_web
        displayName: 'Deploy Web'
        steps:
          - checkout: none
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'Web'
              targetPath: '$(Build.ArtifactStagingDirectory)/Web'
          - task: AzureFileCopy@6
            displayName: 'Copy Web to Blob Storage'
            inputs:
              SourcePath: '$(Build.ArtifactStagingDirectory)/Web/**'
              azureSubscription: '$(subscription)'
              Destination: 'AzureBlob'
              storage: '$(web-storage-account)'
              ContainerName: '$web'
